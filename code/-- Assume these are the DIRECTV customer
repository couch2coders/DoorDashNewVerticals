-- Assume these are the DIRECTV customer populations for 2 months 
-- snapshots Jan and Feb 2024 Some would have HBO subscription (1), 
-- some would not have HBO subscription (0) 

-- Find numbers of new HBO subscription Add in Feb 2024
------METHOD WITHOUT PIVOT TABLE
WITH JAN_SUBS AS
(
    SELECT ACCOUNT_NUMBER
        ,HAS_HBO_SUB AS JAN_HBO_SUBS
    FROM TABLE3
    WHERE EXTRACT(MONTH FROM MONTH_END_DATE) = 1
)

,FEB_SUBS AS
(
    SELECT ACCOUNT_NUMBER
        ,HAS_HBO_SUB AS JAN_HBO_SUBS
    FROM TABLE3
    WHERE EXTRACT(MONTH FROM MONTH_END_DATE) = 1
)

,WIDE_SUBS AS 
(
    SELECT *
        ,IF(JAN_SUBS.ACCOUNT_NUMBER IS NULL,1,0) AS HAD_JAN_ACCT
        ,IF(FEB_SUBS.ACCOUNT_NUMER IS NULL,1,0) AS HAD_FEB_ACCT
    FROM JAN_SUBS
    FULL JOIN FEB_SUBS --FULL JOIN WILL GET ALL SUBS FROM JAN & FEB (SO B & F WILL BE IN BOTH SETS)
    USING(ACCOUNT_NUMBER)
)

-- Find numbers of new HBO subscription Add in Feb 2024
-- Find numbers of HBO subscription Cancellation in Feb 2024
------N_ACCTS FOR CATEGORY FEB_ACCT_ADD IS THE TOTAL ADDED ACCONTS
------N_ACCTS FOR CATEGORY FEB_ACC_DEL IS THE TOTAL CANCELLED SUBS

,STAGE AS 
(
    SELECT 
        --TABLE IS WIDE WITH A 1/0 VALUE IF CUSTOMER HAD AN ACCOUNT IN EACH MONTH
        --3 SCENARIOS POSSIBLE: ADD/DELETE/NO CHANGE
        -----IF I DIDN'T HAVE AN ACCT IN JAN BUT DID HAVE ONE IN FEB, SUB IS NEW
        CASE WHEN HAD_JAN_ACCT = 0
            AND HAD_FEB_ACCT = 1
            THEN 'FEB ACCT ADD'
        -----IF I DID HAVE AN ACCT IN JAN BUT DIDN'T HAVE ONE IN FEB, SUB IS DELETED
        WHEN HAD_JAN_ACCT = 1
            AND HAD_FEB_ACCT = 0
            THEN 'FEB ACCT DEL'
        -----IF HAD AN ACCT IN BOTH JAN & FEB, SUB IS NO CHANGE
        WHEN HAD_JAN_ACCT = 1
            AND HAD_FEB_ACCT = 1
            THEN 'NO ACCT CHG'
        END AS ACCT_TYPE
        ,COUNT(ACCT_NUM) AS N_ACCTS
    FROM WIDE_SUBS
)
---USING THE AMOUNT OF CURRENT SUBSCRIBERS WE HAVE IN FEBRARY AS DENOMINATOR
---------SUM WHERE TAGGED ACCT IS 'FEB ACCT ADD' FOR TOTAL ADDS
---------"" SUBS FOR TOTAL SUBS
---USE ACCOUNTS FLAGGED AS ACCT_ADD/FEB_ACCTS = ADD/CANCEL RATE


SELECT *
    ,ROUND(SAFE_DIVIDE(N_ADDS,N_SUBS),4) AS ADD_RATE
    ,ROUND(SAFE_DIVIDE(N_DELS,N_SUBS),4) AS DEL_RATE
FROM
    (
        SELECT SUM(IF(ACCT_TYPE = 'FEB ACCT ADD',N_ACCTS,0)) AS N_ADDS
            ,SUM(IF(ACCT_TYPE = 'FEB ACCT DEL',N_ACCTS,0)) AS N_DELS
            ,SUM(IF_(ACCT_TYPE IN('FEB ACCT ADD','NO ACCT CHG'),N_ACCTS,0)) AS N_SUBS
    )
